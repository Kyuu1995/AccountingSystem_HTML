<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記帳系統。會員資料</title>
    <link href="font/css/fonts.css" rel="stylesheet" type="text/css">
    <link href="font/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet">
</head>

<body onload="getVariable(), showProfile()">
    <header>
        <div class="header">
            <a href="javascript:;" onclick="doHome()">
                <img src="./images/logo.svg" alt="logo">
                <div class="title">k<span class="span-1">e</span><span class="span-2">e</span>p a<span
                        class="span-1">cc</span>ount<span class="span-2">s</span></div>
            </a>
        </div>
    </header>
    <section>
        <form class="index-form">
            <div class="index-title" name="title" id="title">會員資料</div>
            <div class="index-input">
                <p name="usernameP" id="usernameP" style="display: none">
                    <label for="username">Username<br></label>
                    <input type="text" name="username" id="username" disabled>
                </p>
                <p name="passwordP" id="passwordP" style="display: none">
                    <label for="password">Password<br></label>
                    <input type="password" name="password" id="password">
                </p>
                <p name="passwordCheckP" id="passwordCheckP" style="display: none">
                    <label for="passwordCheck">Password Check</label>
                    <input type="password" name="passwordCheck" id="passwordCheck">
                </p>
                <p name="NicknameP" id="NicknameP">
                    <label for="Nickname">Nickname</label>
                    <input type="text" name="Nickname" id="Nickname" disabled>
                </p>
                <p name="emailP" id="emailP">
                    <label for="email">E-mail</label>
                    <input type="email" name="email" id="email" disabled>
                </p>
                <p name="genderP" id="genderP">
                    <label for="gender">Gender</label>
                    <select name="gender" id="gender" disabled>
                        <option value="0">請選擇項目</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </p>
            </div>
            <div class="index-button">
                <input type="button" name="modifyBtn" id="modifyBtn" value="修改" onclick="modify()">
                <input type="button" name="modifyDefineBtn" id="modifyDefineBtn" value="確定" onclick="modifyDefine()"
                    style="display: none">
                <input type="button" name="modifyCancelBtn" id="modifyCancelBtn" value="取消" onclick="modifyCancel()"
                    style="display: none">
                <input type="button" name="changeBtn" id="changeBtn" value="變更密碼" onclick="change()">
                <input type="button" name="changeDefineBtn" id="changeDefineBtn" value="確定" onclick="changeDefine()"
                    style="display: none">
                <input type="button" name="changeCancelBtn" id="changeCancelBtn" value="取消" onclick="changeCancel()"
                    style="display: none">
                <a href="./index.html"><input type="button" name="signOutBtn" id="signOutBtn" value="登出"></a>
            </div>
        </form>
        <form class="variable" name="variable" id="variable">
            <input type="text" name="nickname" id="nickname">
            <input type="text" name="user" id="user">
        </form>
    </section>
    <footer>
        <div class="footer">
            <div class="footer-1">
                <div class="footer-title">use web</div>
                <div class="footer-a">
                    <a href="https://fontawesome.com/" target="_new">
                        <img src="./images/logo_FontAwesome_.png">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://www.iconfinder.com/editor/" target="_new">
                        <img src="./images/logo_Iconfinder.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://www.svgrepo.com/" target="_new">
                        <img src="./images/logo_SVGRepo.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://www.cufonfonts.com/" target="_new">
                        <img src="./images/logo_CufonFonts.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://pixlr.com/tw/" target="_new">
                        <img src="./images/logo_Pixlr.svg">
                    </a>
                </div>
            </div>
            <div class="footer-2">
                <div class="footer-title">use language</div>
                <div class="footer-a">
                    <a href="https://en.wikipedia.org/wiki/HTML" target="_new">
                        <img src="./images/logo_HTML.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://en.wikipedia.org/wiki/CSS" target="_new">
                        <img src="./images/logo_CSS.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://en.wikipedia.org/wiki/JavaScript" target="_new">
                        <img src="./images/logo_JavaScript.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://jquery.com/" target="_new">
                        <img src="./images/logo_jQuery.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://www.mysql.com/" target="_new">
                        <img src="./images/logo_MySQL.svg">
                    </a>
                </div>
                <div class="footer-a">
                    <a href="https://www.oracle.com/java/" target="_new">
                        <img src="./images/logo_Java.svg">
                    </a>
                </div>
            </div>
        </div>
    </footer>
</body>

<script src="js/jquery-3.6.0.min.js"></script>
<script src="js/md5.js"></script>
<script>
    var variable = document.getElementById("variable")
    var nickname
    var user
    var title = document.getElementById("title")
    var username = document.getElementById("username")
    var password = document.getElementById("password")
    var passwordCheck = document.getElementById("passwordCheck")
    var Nickname = document.getElementById("Nickname")
    var email = document.getElementById("email")
    var gender = document.getElementById("gender")
    var usernameP = document.getElementById("usernameP")
    var passwordP = document.getElementById("passwordP")
    var passwordCheckP = document.getElementById("passwordCheckP")
    var NicknameP = document.getElementById("NicknameP")
    var emailP = document.getElementById("emailP")
    var genderP = document.getElementById("genderP")
    var modifyBtn = document.getElementById("modifyBtn")
    var modifyDefineBtn = document.getElementById("modifyDefineBtn")
    var modifyCancelBtn = document.getElementById("modifyCancelBtn")
    var changeBtn = document.getElementById("changeBtn")
    var changeDefineBtn = document.getElementById("changeDefineBtn")
    var changeCancelBtn = document.getElementById("changeCancelBtn")
    var signOutBtn = document.getElementById("signOutBtn")

    function getVariable() {
        if (location.href.indexOf('?') != -1) {
            var ary = location.href.split('?')[1].split('&')
            for (var i = 0; i <= ary.length - 1; i++) {
                if (ary[i].split('=')[0] == 'nickname') {
                    nickname = ary[i].split('=')[1]
                    document.getElementById("nickname").value = nickname
                } else if (ary[i].split('=')[0] == 'user') {
                    user = ary[i].split('=')[1]
                    document.getElementById("user").value = user
                }
            }
        }
    }
    function doHome() {
        variable.method = "get"
        variable.action = "./home.html"
        variable.submit()
    }
    function validate() {
        if ($("#password").val() == "") {
            alert("請輸入新密碼....")
        } else if ($("#passwordCheck").val() == "") {
            alert("請再次輸入新密碼....")
        } else {
            return true
        }
    }
    function checkPassword() {
        var thisPassword
        $.ajax({
            async: false,
            url: "http://localhost:8080/AccountingSystem/doCheckPassword",
            type: "post",
            traditional: true,
            dataType: "json",
            data: {
                user: user
            },
            success: function (response) {
                thisPassword = response.password
            }
        })
        if (hex_md5(prompt("請輸入密碼︰")) == thisPassword) {
            return true
        } else {
            return false
        }
    }
    function showProfile() {
        $.ajax({
            async: false,
            url: "http://localhost:8080/AccountingSystem/doShowProfile",
            type: "post",
            traditional: true,
            dataType: "json",
            data: {
                user: user
            },
            success: function (response) {
                Nickname.value = response.nickname
                email.value = response.email
                gender.value = response.gender
            }
        })
    }
    function modify() {
        if (checkPassword()) {
            title.innerHTML = "修改資料"
            Nickname.disabled = ""
            email.disabled = ""
            gender.disabled = ""
            modifyBtn.style.display = "none"
            modifyDefineBtn.style.display = ""
            modifyCancelBtn.style.display = ""
            changeBtn.style.display = "none"
            signOutBtn.style.display = "none"
        } else {
            alert("密碼輸入錯誤....")
        }
    }
    function modifyDefine() {
        $.ajax({
            async: false,
            url: "http://localhost:8080/AccountingSystem/doUpdateProfile",
            type: "post",
            traditional: true,
            dataType: "json",
            data: {
                user: user,
                nickname: $("#Nickname").val(),
                email: $("#email").val(),
                gender: $("#gender").val()
            },
            success: function (response) {
                showProfile()
                modifyCancel()
                alert(response.message)
                document.getElementById("nickname").value = Nickname.value
            }
        })
    }
    function modifyCancel() {
        showProfile()
        title.innerHTML = "會員資料"
        Nickname.disabled = "none"
        email.disabled = "none"
        gender.disabled = "none"
        modifyBtn.style.display = ""
        modifyDefineBtn.style.display = "none"
        modifyCancelBtn.style.display = "none"
        changeBtn.style.display = ""
        signOutBtn.style.display = ""
    }
    function change() {
        if (checkPassword()) {
            title.innerHTML = "變更密碼"
            usernameP.style.display = ""
            passwordP.style.display = ""
            passwordCheckP.style.display = ""
            NicknameP.style.display = "none"
            emailP.style.display = "none"
            genderP.style.display = "none"
            modifyBtn.style.display = "none"
            changeBtn.style.display = "none"
            changeDefineBtn.style.display = ""
            changeCancelBtn.style.display = ""
            signOutBtn.style.display = "none"
            $.ajax({
                async: false,
                url: "http://localhost:8080/AccountingSystem/doShowUsername",
                type: "post",
                traditional: true,
                dataType: "json",
                data: {
                    user: user
                },
                success: function (response) {
                    username.value = response.username
                }
            })
        } else {
            alert("密碼輸入錯誤....")
        }
    }
    function changeDefine() {
        if (validate()) {
            if ($("#password").val() == $("#passwordCheck").val()) {
                $.ajax({
                    async: false,
                    url: "http://localhost:8080/AccountingSystem/doUpdatePassword",
                    type: "post",
                    traditional: true,
                    dataType: "json",
                    data: {
                        user: user,
                        password: hex_md5($("#password").val())
                    },
                    success: function (response) {
                        password.value = ""
                        passwordCheck.value = ""
                        changeCancel()
                        showProfile()
                        modifyCancel()
                        alert(response.message)
                    }
                })
            } else {
                alert("再次輸入的密碼和原密碼不相符....")
                passwordCheck.value = ""
            }
        }
    }
    function changeCancel() {
        showProfile()
        title.innerHTML = "會員資料"
        password.value = ""
        passwordCheck.value = ""
        usernameP.style.display = "none"
        passwordP.style.display = "none"
        passwordCheckP.style.display = "none"
        NicknameP.style.display = ""
        emailP.style.display = ""
        genderP.style.display = ""
        modifyBtn.style.display = ""
        changeBtn.style.display = ""
        changeDefineBtn.style.display = "none"
        changeCancelBtn.style.display = "none"
        signOutBtn.style.display = ""
    }
</script>

</html>